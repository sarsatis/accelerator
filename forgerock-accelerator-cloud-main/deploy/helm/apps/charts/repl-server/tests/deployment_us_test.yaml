suite: repl-server-us deployment tests 
templates:
  - ../templates/deploy-rs-us.yaml
tests:
  - it: Check deploy.yaml values
    values:
      - ../values.yaml
      - ../../../values.yaml

    asserts:
      - isKind:
          of: StatefulSet
      - isAPIVersion:
          of: apps/v1 
      - equal:
          path: metadata.name
          value: forgerock-repl-server-us-dc1
      - matchRegex:
          path: metadata.namespace
          pattern: ^forgerock.*
      - equal:
          path: spec.serviceName
          value: forgerock-repl-server-us
      - exists:
          path: spec.replicas
      - equal:
          path: spec.podManagementPolicy
          value: Parallel
      - equal:
          path: spec.selector.matchLabels.app
          value: forgerock-repl-server-us-dc1
      - equal:
          path: spec.template.metadata.labels.app
          value: forgerock-repl-server-us-dc1
      - equal:
          path: spec.template.spec.affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution[0].weight
          value: 1
      - equal:
          path: spec.template.spec.affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution[0].podAffinityTerm.labelSelector.matchExpressions[0].key
          value: app
      - equal:
          path: spec.template.spec.affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution[0].podAffinityTerm.labelSelector.matchExpressions[0].operator
          value: In
      - equal:
          path: spec.template.spec.affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution[0].podAffinityTerm.labelSelector.matchExpressions[0].values[0]
          value: forgerock-repl-server-us-dc1
      - equal:
          path: spec.template.spec.affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution[0].podAffinityTerm.topologyKey
          value: kubernetes.io/hostname
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 10002
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 10002
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 10002
      - equal:
          path: spec.template.spec.volumes[0].name
          value: pvc
      - equal:
          path: spec.template.spec.volumes[0].persistentVolumeClaim.claimName
          value: pvc
      - equal:
          path: spec.template.spec.containers[0].name
          value: forgerock-repl-server-us-dc1
      - equal:
          path: spec.template.spec.containers[0].image
          value: gcr.io/massive-dynamo-235117/forgerock-repl-server:stable
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.privileged
          value: false
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].mountPath
          value: /opt/ds/app
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].name
          value: pvc
      - exists:
          path: spec.template.spec.containers[0].resources.requests.cpu
      - exists:
          path: spec.template.spec.containers[0].resources.requests.memory
      - exists:
          path: spec.template.spec.containers[0].resources.limits.cpu
      - exists:
          path: spec.template.spec.containers[0].resources.limits.memory
      - equal:
          path: spec.template.spec.containers[0].startupProbe.exec.command[0]
          value: cat
      - equal:
          path: spec.template.spec.containers[0].startupProbe.exec.command[1]
          value: /opt/ds/ds_setup_done
      - exists:
          path: spec.template.spec.containers[0].startupProbe.initialDelaySeconds
      - exists:
          path: spec.template.spec.containers[0].startupProbe.failureThreshold
      - exists:
          path: spec.template.spec.containers[0].startupProbe.periodSeconds
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 8443
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value:  /alive
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.scheme
          value: HTTPS
      - exists:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
      - exists:
          path: spec.template.spec.containers[0].livenessProbe.successThreshold
      - exists:
          path: spec.template.spec.containers[0].livenessProbe.failureThreshold
      - exists:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
      - exists:
          path: spec.template.spec.containers[0].livenessProbe.timeoutSeconds
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 8443
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /alive
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.scheme
          value: HTTPS
      - exists:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
      - exists:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
      - exists:
          path: spec.template.spec.containers[0].readinessProbe.successThreshold
      - exists:
          path: spec.template.spec.containers[0].readinessProbe.failureThreshold
      - exists:
          path: spec.template.spec.containers[0].readinessProbe.timeoutSeconds
      - equal:
          path: spec.template.spec.containers[0].envFrom[0].secretRef.name
          value: forgerock-repl-server-dc1
      - equal:
          path: spec.template.spec.containers[0].envFrom[1].configMapRef.name
          value: forgerock-repl-server-us-dc1
      - equal:
          path: spec.template.spec.containers[0].env[0].name
          value: REPLICAS
      - exists:
          path: spec.template.spec.containers[0].env[0].value
      - equal:
          path: spec.template.spec.containers[0].env[1].name
          value: SECRET_CERTIFICATE_US
      - equal:
          path: spec.template.spec.containers[0].env[1].valueFrom.secretKeyRef.name
          value: forgerock-user-store-dc1
      - equal:
          path: spec.template.spec.containers[0].env[1].valueFrom.secretKeyRef.key
          value: SECRET_CERTIFICATE
      - equal:
          path: spec.template.spec.containers[0].env[2].name
          value: SECRET_CERTIFICATE_TS
      - equal:
          path: spec.template.spec.containers[0].env[2].valueFrom.secretKeyRef.name
          value: forgerock-token-store-dc1
      - equal:
          path: spec.template.spec.containers[0].env[2].valueFrom.secretKeyRef.key
          value: SECRET_CERTIFICATE
      - equal:
          path: spec.template.spec.containers[0].env[3].name
          value: SECRET_CERTIFICATE_APS
      - equal:
          path: spec.template.spec.containers[0].env[3].valueFrom.secretKeyRef.name
          value: forgerock-app-policy-store-dc1
      - equal:
          path: spec.template.spec.containers[0].env[3].valueFrom.secretKeyRef.key
          value: SECRET_CERTIFICATE
      - equal:
          path: spec.template.spec.containers[0].ports[0].name
          value: ldap
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 1389
      - equal:
          path: spec.template.spec.containers[0].ports[0].protocol
          value: TCP
      - equal:
          path: spec.template.spec.containers[0].ports[1].name
          value: ldaps
      - equal:
          path: spec.template.spec.containers[0].ports[1].containerPort
          value: 1636
      - equal:
          path: spec.template.spec.containers[0].ports[1].protocol
          value: TCP
      - equal:
          path: spec.template.spec.containers[0].ports[2].name
          value: admin
      - equal:
          path: spec.template.spec.containers[0].ports[2].containerPort
          value: 4444
      - equal:
          path: spec.template.spec.containers[0].ports[2].protocol
          value: TCP
      - equal:
          path: spec.template.spec.containers[0].ports[3].name
          value: replication
      - equal:
          path: spec.template.spec.containers[0].ports[3].containerPort
          value: 8989
      - equal:
          path: spec.template.spec.containers[0].ports[3].protocol
          value: TCP
      - equal:
          path: spec.template.spec.containers[0].ports[4].name
          value: http
      - equal:
          path: spec.template.spec.containers[0].ports[4].containerPort
          value: 8080
      - equal:
          path: spec.template.spec.containers[0].ports[4].protocol
          value: TCP
      - equal:
          path: spec.template.spec.containers[0].ports[5].name
          value: https
      - equal:
          path: spec.template.spec.containers[0].ports[5].containerPort
          value: 8443
      - equal:
          path: spec.template.spec.containers[0].ports[5].protocol
          value: TCP


      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: fr-nexus-docker
      - equal:
          path: spec.volumeClaimTemplates[0].metadata.name
          value: pvc
      - equal:
          path: spec.volumeClaimTemplates[0].metadata.annotations
          value: 
            pv.beta.kubernetes.io/gid: "0"
      - equal:
          path: spec.volumeClaimTemplates[0].spec.accessModes[0]
          value: ReadWriteOnce
      - equal:
          path: spec.volumeClaimTemplates[0].spec.resources.requests.storage
          value: 20Gi